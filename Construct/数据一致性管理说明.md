# çŸ¥è¯†å›¾è°±æ•°æ®ä¸€è‡´æ€§ç®¡ç†ç³»ç»Ÿ

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

æœ¬ç³»ç»Ÿæä¾›äº†ä¸€ä¸ª**æ•°æ®ä¸€è‡´æ€§ç®¡ç†å±‚**ï¼Œç”¨äºç®¡ç†çŸ¥è¯†å›¾è°±æ–‡çŒ®åœ¨ä¸‰ä¸ªå­˜å‚¨ç³»ç»Ÿé—´çš„ä¸€è‡´æ€§ï¼š

1. **æ–‡ä»¶ç³»ç»Ÿ** - `O:\MyProject\Knowledges\` ä¸‹çš„æ–‡ä»¶å¤¹
2. **Redis** - å‘é‡ç´¢å¼•ï¼ˆç”¨äºè¯­ä¹‰æ£€ç´¢ï¼‰
3. **Neo4j** - çŸ¥è¯†å›¾è°±ï¼ˆç”¨äºå…³ç³»æ¨ç†ï¼‰

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. è‡ªåŠ¨æ³¨å†Œ

åœ¨æ„å»ºçŸ¥è¯†å›¾è°±æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ³¨å†Œæ–‡æ¡£çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬ï¼š
- æ–‡æ¡£åç§°
- æ–‡ä»¶è·¯å¾„
- Redisç´¢å¼•åˆ—è¡¨
- Neo4jæ ‡ç­¾åˆ—è¡¨
- å®ä½“æ•°é‡å’Œå…³ç³»æ•°é‡
- åˆ›å»º/æ›´æ–°æ—¶é—´

### 2. ç»Ÿä¸€åˆ é™¤

åˆ é™¤æ–‡æ¡£æ—¶ï¼Œç³»ç»Ÿä¼šåŒæ—¶æ¸…ç†ä¸‰ä¸ªå­˜å‚¨ç³»ç»Ÿä¸­çš„ç›¸å…³èµ„æºï¼š

```python
# ç¤ºä¾‹ï¼šåˆ é™¤æ–‡æ¡£
result = data_manager.delete_document(
    document_name="åæ­»æ€§è½¯ç»„ç»‡æ„ŸæŸ“ä¸´åºŠè¯Šæ²»æ€¥è¯Šä¸“å®¶å…±è¯†",
    delete_files=True,      # åˆ é™¤æ–‡ä»¶å¤¹
    delete_redis=True,      # åˆ é™¤Redisç´¢å¼•
    delete_neo4j=True,      # åˆ é™¤Neo4jèŠ‚ç‚¹
    dry_run=False          # False=å®é™…åˆ é™¤ï¼ŒTrue=é¢„æ¼”
)
```

### 3. å…ƒæ•°æ®åŒæ­¥

æ”¯æŒæ‰«ææ‰€æœ‰æ–‡æ¡£å¹¶åŒæ­¥å…ƒæ•°æ®ï¼š

```python
# åŒæ­¥æ‰€æœ‰æ–‡æ¡£
data_manager.sync_metadata()

# åŒæ­¥ç‰¹å®šæ–‡æ¡£
data_manager.sync_metadata(document_name="æ–‡æ¡£åç§°")
```

### 4. å­¤ç«‹èµ„æºæ¸…ç†

è‡ªåŠ¨æ£€æµ‹å¹¶æ¸…ç†å­¤ç«‹èµ„æºï¼ˆå­˜åœ¨äºRedis/Neo4jä½†å…ƒæ•°æ®ä¸­æ²¡æœ‰çš„ï¼‰ï¼š

```python
# é¢„æ¼”æ¨¡å¼ï¼ˆåªæ£€æµ‹ä¸åˆ é™¤ï¼‰
orphaned = data_manager.cleanup_orphaned_resources(dry_run=True)

# å®é™…æ¸…ç†
orphaned = data_manager.cleanup_orphaned_resources(dry_run=False)
```

## ğŸ“Š èµ„æºæ˜ å°„å…³ç³»

æ¯ä¸ªæ–‡æ¡£å¯¹åº”çš„èµ„æºï¼š

### æ–‡ä»¶ç³»ç»Ÿ
```
O:\MyProject\Knowledges\
â””â”€â”€ {document_name}\
    â”œâ”€â”€ 01_raw.html              # åŸå§‹HTML
    â”œâ”€â”€ 02_cleaned.html          # æ¸…æ´—åHTML
    â”œâ”€â”€ 03_document.md           # Markdownæ–‡æ¡£
    â””â”€â”€ 04_knowledge_graph.json  # çŸ¥è¯†å›¾è°±JSON
```

### Redisç´¢å¼•
```
kg_{document_name_safe}              # Markdownæ–‡æ¡£å‘é‡ç´¢å¼•
symptom_vectors_{document_name_safe} # ç—‡çŠ¶å‘é‡ç´¢å¼•ï¼ˆå¦‚æœæœ‰ï¼‰
```

### Neo4jèŠ‚ç‚¹
```
LiteratureSourceèŠ‚ç‚¹ (name = document_name)
â””â”€â”€ æ‰€æœ‰é€šè¿‡SOURCE_FROMå…³ç³»è¿æ¥çš„å®ä½“èŠ‚ç‚¹
    â”œâ”€â”€ Disease
    â”œâ”€â”€ Symptom
    â”œâ”€â”€ Treatment
    â””â”€â”€ ...
```

## ğŸ”§ APIæ¥å£

### åç«¯APIï¼ˆFastAPIï¼‰

#### 1. åˆ é™¤æ–‡æ¡£
```http
DELETE /api/knowledge/delete/{document_name}?delete_files=true&delete_redis=true&delete_neo4j=true
```

**å‚æ•°**ï¼š
- `document_name`: æ–‡æ¡£åç§°ï¼ˆè·¯å¾„å‚æ•°ï¼‰
- `delete_files`: æ˜¯å¦åˆ é™¤æ–‡ä»¶å¤¹ï¼ˆé»˜è®¤trueï¼‰
- `delete_redis`: æ˜¯å¦åˆ é™¤Redisç´¢å¼•ï¼ˆé»˜è®¤trueï¼‰
- `delete_neo4j`: æ˜¯å¦åˆ é™¤Neo4jèŠ‚ç‚¹ï¼ˆé»˜è®¤trueï¼‰

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "æ–‡æ¡£åˆ é™¤æˆåŠŸ",
  "result": {
    "document_name": "åæ­»æ€§è½¯ç»„ç»‡æ„ŸæŸ“ä¸´åºŠè¯Šæ²»æ€¥è¯Šä¸“å®¶å…±è¯†",
    "files_deleted": true,
    "redis_deleted": ["kg_åæ­»æ€§è½¯ç»„ç»‡æ„ŸæŸ“ä¸´åºŠè¯Šæ²»æ€¥è¯Šä¸“å®¶å…±è¯†", "symptom_vectors_åæ­»æ€§è½¯ç»„ç»‡æ„ŸæŸ“ä¸´åºŠè¯Šæ²»æ€¥è¯Šä¸“å®¶å…±è¯†"],
    "neo4j_deleted": true,
    "errors": []
  }
}
```

#### 2. åŒæ­¥å…ƒæ•°æ®
```http
POST /api/knowledge/sync-metadata
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "å…ƒæ•°æ®åŒæ­¥å®Œæˆ",
  "stats": {
    "total_documents": 2,
    "redis_available": true,
    "neo4j_available": true,
    "documents": [...]
  }
}
```

#### 3. è·å–å­˜å‚¨ç»Ÿè®¡
```http
GET /api/knowledge/stats
```

**å“åº”**ï¼š
```json
{
  "total_documents": 2,
  "redis_available": true,
  "neo4j_available": true,
  "documents": [
    {
      "name": "åæ­»æ€§è½¯ç»„ç»‡æ„ŸæŸ“ä¸´åºŠè¯Šæ²»æ€¥è¯Šä¸“å®¶å…±è¯†",
      "entity_count": 127,
      "relationship_count": 137,
      "redis_indices": 2,
      "created_at": "2025-10-28T15:20:00"
    }
  ]
}
```

### å‰ç«¯APIï¼ˆVue.jsï¼‰

```javascript
import { deleteKnowledgeDocument, syncMetadata, getStorageStats } from '@/api/knowledge'

// åˆ é™¤æ–‡æ¡£
const result = await deleteKnowledgeDocument(
  'åæ­»æ€§è½¯ç»„ç»‡æ„ŸæŸ“ä¸´åºŠè¯Šæ²»æ€¥è¯Šä¸“å®¶å…±è¯†',
  true,  // deleteFiles
  true,  // deleteRedis
  true   // deleteNeo4j
)

// åŒæ­¥å…ƒæ•°æ®
const syncResult = await syncMetadata()

// è·å–ç»Ÿè®¡ä¿¡æ¯
const stats = await getStorageStats()
```

## ğŸ“ å…ƒæ•°æ®æ–‡ä»¶

æ‰€æœ‰å…ƒæ•°æ®å­˜å‚¨åœ¨ `O:\MyProject\Knowledges\_metadata.json`ï¼š

```json
{
  "åæ­»æ€§è½¯ç»„ç»‡æ„ŸæŸ“ä¸´åºŠè¯Šæ²»æ€¥è¯Šä¸“å®¶å…±è¯†": {
    "document_name": "åæ­»æ€§è½¯ç»„ç»‡æ„ŸæŸ“ä¸´åºŠè¯Šæ²»æ€¥è¯Šä¸“å®¶å…±è¯†",
    "created_at": "2025-10-28T15:20:00",
    "updated_at": "2025-10-28T15:23:00",
    "file_path": "O:\\MyProject\\Knowledges\\åæ­»æ€§è½¯ç»„ç»‡æ„ŸæŸ“ä¸´åºŠè¯Šæ²»æ€¥è¯Šä¸“å®¶å…±è¯†",
    "redis_indices": [
      "kg_åæ­»æ€§è½¯ç»„ç»‡æ„ŸæŸ“ä¸´åºŠè¯Šæ²»æ€¥è¯Šä¸“å®¶å…±è¯†",
      "symptom_vectors_åæ­»æ€§è½¯ç»„ç»‡æ„ŸæŸ“ä¸´åºŠè¯Šæ²»æ€¥è¯Šä¸“å®¶å…±è¯†"
    ],
    "neo4j_labels": ["Disease", "Symptom", "Treatment", "Test", "Pathogen"],
    "entity_count": 127,
    "relationship_count": 137,
    "status": "active"
  }
}
```

## âš™ï¸ ä½¿ç”¨æµç¨‹

### 1. æ„å»ºçŸ¥è¯†å›¾è°±ï¼ˆè‡ªåŠ¨æ³¨å†Œï¼‰

å½“ç”¨æˆ·åœ¨å‰ç«¯ç‚¹å‡»"æ„å»ºçŸ¥è¯†å›¾è°±"æŒ‰é’®æ—¶ï¼Œç³»ç»Ÿä¼šï¼š
1. å¯¼å…¥Neo4j
2. åˆ›å»ºç—‡çŠ¶å‘é‡ç´¢å¼•ï¼ˆNeo4jå‘é‡ï¼‰
3. åˆ›å»ºæ–‡æ¡£å‘é‡ç´¢å¼•ï¼ˆRediså‘é‡ï¼‰
4. **è‡ªåŠ¨æ³¨å†Œåˆ°æ•°æ®ç®¡ç†å™¨** âœ¨

### 2. åˆ é™¤æ–‡æ¡£

åœ¨å‰ç«¯æ–‡æ¡£åˆ—è¡¨ä¸­æ·»åŠ åˆ é™¤æŒ‰é’®ï¼š

```vue
<el-button 
  type="danger" 
  size="small"
  @click="handleDelete(doc.name)"
>
  åˆ é™¤
</el-button>

<script>
const handleDelete = async (docName) => {
  try {
    await ElMessageBox.confirm(
      'æ­¤æ“ä½œå°†åˆ é™¤æ–‡æ¡£çš„æ‰€æœ‰èµ„æºï¼ˆæ–‡ä»¶ã€Redisç´¢å¼•ã€Neo4jèŠ‚ç‚¹ï¼‰ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ',
      'è­¦å‘Š',
      {
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning'
      }
    )
    
    const result = await deleteKnowledgeDocument(docName)
    
    if (result.success) {
      ElMessage.success('æ–‡æ¡£åˆ é™¤æˆåŠŸ')
      await loadAllDocuments() // åˆ·æ–°åˆ—è¡¨
    } else {
      ElMessage.error(`åˆ é™¤å¤±è´¥: ${result.message}`)
    }
  } catch (error) {
    console.error('åˆ é™¤å¤±è´¥:', error)
  }
}
</script>
```

### 3. ç»´æŠ¤å…ƒæ•°æ®

å®šæœŸåŒæ­¥å…ƒæ•°æ®ä»¥ç¡®ä¿ä¸€è‡´æ€§ï¼š

```python
# åœ¨åå°å®šæ—¶ä»»åŠ¡æˆ–ç®¡ç†è„šæœ¬ä¸­
from Construct.knowledge_data_manager import get_data_manager

manager = get_data_manager()

# åŒæ­¥å…ƒæ•°æ®
manager.sync_metadata()

# æ¸…ç†å­¤ç«‹èµ„æº
orphaned = manager.cleanup_orphaned_resources(dry_run=False)
```

## ğŸ›¡ï¸ å®‰å…¨æ€§

### é¢„æ¼”æ¨¡å¼

æ‰€æœ‰åˆ é™¤æ“ä½œéƒ½æ”¯æŒé¢„æ¼”æ¨¡å¼ï¼ˆ`dry_run=True`ï¼‰ï¼Œåœ¨å®é™…åˆ é™¤å‰å¯ä»¥å…ˆæ£€æŸ¥ï¼š

```python
# é¢„æ¼”ï¼šæŸ¥çœ‹å°†è¦åˆ é™¤ä»€ä¹ˆ
result = data_manager.delete_document(
    document_name="æ–‡æ¡£åç§°",
    dry_run=True  # åªæ£€æŸ¥ä¸åˆ é™¤
)

print(f"å°†åˆ é™¤æ–‡ä»¶: {result['files_deleted']}")
print(f"å°†åˆ é™¤Redisç´¢å¼•: {result['redis_deleted']}")
print(f"å°†åˆ é™¤Neo4jèŠ‚ç‚¹: {result['neo4j_deleted']}")
```

### é”™è¯¯å¤„ç†

ç³»ç»Ÿä¼šè®°å½•æ‰€æœ‰é”™è¯¯ï¼Œå³ä½¿éƒ¨åˆ†èµ„æºåˆ é™¤å¤±è´¥ä¹Ÿä¸ä¼šå½±å“å…¶ä»–èµ„æºï¼š

```json
{
  "success": false,
  "message": "åˆ é™¤è¿‡ç¨‹ä¸­é‡åˆ° 1 ä¸ªé”™è¯¯",
  "result": {
    "files_deleted": true,
    "redis_deleted": ["kg_xxx"],
    "neo4j_deleted": false,
    "errors": ["åˆ é™¤Neo4jèŠ‚ç‚¹å¤±è´¥: Connection refused"]
  }
}
```

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

ç³»ç»Ÿä½¿ç”¨Python loggingæ¨¡å—è®°å½•æ‰€æœ‰æ“ä½œï¼š

```
2025-10-28 15:20:00 - INFO - âœ“ Redisè¿æ¥æˆåŠŸ
2025-10-28 15:20:00 - INFO - âœ“ Neo4jè¿æ¥æˆåŠŸ
2025-10-28 15:20:05 - INFO - âœ“ å·²æ³¨å†Œæ–‡æ¡£: åæ­»æ€§è½¯ç»„ç»‡æ„ŸæŸ“ä¸´åºŠè¯Šæ²»æ€¥è¯Šä¸“å®¶å…±è¯†
2025-10-28 15:25:00 - INFO - å¼€å§‹åˆ é™¤æ–‡æ¡£: åæ­»æ€§è½¯ç»„ç»‡æ„ŸæŸ“ä¸´åºŠè¯Šæ²»æ€¥è¯Šä¸“å®¶å…±è¯†
2025-10-28 15:25:01 - INFO -   âœ“ å·²åˆ é™¤æ–‡ä»¶å¤¹: O:\MyProject\Knowledges\...
2025-10-28 15:25:02 - INFO -   âœ“ å·²åˆ é™¤Redisç´¢å¼•: kg_åæ­»æ€§è½¯ç»„ç»‡æ„ŸæŸ“ä¸´åºŠè¯Šæ²»æ€¥è¯Šä¸“å®¶å…±è¯†
2025-10-28 15:25:03 - INFO -   âœ“ å·²åˆ é™¤Neo4jèŠ‚ç‚¹: 128 ä¸ª
2025-10-28 15:25:03 - INFO -   âœ“ å·²ä»å…ƒæ•°æ®ä¸­åˆ é™¤
2025-10-28 15:25:03 - INFO - âœ“ åˆ é™¤æˆåŠŸ: åæ­»æ€§è½¯ç»„ç»‡æ„ŸæŸ“ä¸´åºŠè¯Šæ²»æ€¥è¯Šä¸“å®¶å…±è¯†
```

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šåˆ é™¤æ–‡æ¡£æ—¶æ–‡ä»¶å¤¹æ— æ³•åˆ é™¤

**åŸå› **ï¼šæ–‡ä»¶è¢«å ç”¨  
**è§£å†³**ï¼šå…³é—­æ‰€æœ‰æ‰“å¼€è¯¥æ–‡ä»¶å¤¹çš„ç¨‹åºï¼ˆå¦‚IDEã€æ–‡ä»¶ç®¡ç†å™¨ï¼‰

### é—®é¢˜2ï¼šRedisç´¢å¼•åˆ é™¤å¤±è´¥

**åŸå› **ï¼šRedisæœªå¯åŠ¨æˆ–è¿æ¥å¤±è´¥  
**è§£å†³**ï¼šæ£€æŸ¥RedisæœåŠ¡çŠ¶æ€ï¼Œç¡®ä¿`localhost:6379`å¯è®¿é—®

### é—®é¢˜3ï¼šNeo4jèŠ‚ç‚¹åˆ é™¤å¤±è´¥

**åŸå› **ï¼šNeo4jæœªå¯åŠ¨æˆ–è®¤è¯å¤±è´¥  
**è§£å†³**ï¼šæ£€æŸ¥Neo4jæœåŠ¡ï¼Œç¡®è®¤ç”¨æˆ·åå¯†ç æ­£ç¡®

### é—®é¢˜4ï¼šå…ƒæ•°æ®ä¸åŒæ­¥

**è§£å†³**ï¼šè¿è¡ŒåŒæ­¥å‘½ä»¤
```python
from Construct.knowledge_data_manager import get_data_manager
manager = get_data_manager()
manager.sync_metadata()
```

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `Construct/knowledge_data_manager.py` - æ•°æ®ç®¡ç†å™¨æ ¸å¿ƒä»£ç 
- `backend_api.py` - åç«¯APIæ¥å£
- `frontend/src/api/knowledge.js` - å‰ç«¯APIè°ƒç”¨
- `Knowledges/_metadata.json` - å…ƒæ•°æ®å­˜å‚¨

## ğŸ¯ æœ€ä½³å®è·µ

1. âœ… æ¯æ¬¡æ„å»ºçŸ¥è¯†å›¾è°±åä¼šè‡ªåŠ¨æ³¨å†Œï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
2. âœ… åˆ é™¤æ–‡æ¡£å‰ä½¿ç”¨é¢„æ¼”æ¨¡å¼æ£€æŸ¥
3. âœ… å®šæœŸè¿è¡Œå…ƒæ•°æ®åŒæ­¥ç¡®ä¿ä¸€è‡´æ€§
4. âœ… å®šæœŸæ¸…ç†å­¤ç«‹èµ„æºèŠ‚çœå­˜å‚¨ç©ºé—´
5. âœ… æŸ¥çœ‹æ—¥å¿—äº†è§£æ“ä½œè¯¦æƒ…
6. âœ… å¤‡ä»½é‡è¦æ•°æ®ï¼ˆç‰¹åˆ«æ˜¯`_metadata.json`ï¼‰

