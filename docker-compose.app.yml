# ============================================================================
# 医疗多智能体系统 - 应用服务部署配置
# 仅包含应用服务：MCP、Backend、Frontend
# 连接外部已存在的Redis和Neo4j
# 适用场景：已经部署过Redis和Neo4j，只需要部署应用
# 使用方式：docker-compose -f docker-compose.app.yml up -d
# ============================================================================

 

services:
  # ==========================================================================
  # 应用服务
  # ==========================================================================

  # MCP服务 - 模型上下文协议服务（症状搜索和诊断建议）
  mcp:
    build:
      context: .
      dockerfile: Dockerfile.mcp
    image: medical-mcp:latest
    container_name: medical-mcp
    ports:
      - "${MCP_PORT:-8000}:8000"
    environment:
      # Neo4j配置 - 连接到外部Neo4j
      - NEO4J_URI=${NEO4J_URI}
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
    volumes:
      # 模型目录（如果宿主机已下载模型，可挂载以避免重复下载）
      - ${HOST_MODEL_PATH:-./RAG/models}:/app/RAG/models
    healthcheck:

      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8000/sse || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - medical-network
    # 如果外部数据库在同一Docker网络，可以使用extra_hosts
    # 如果外部数据库在宿主机或其他网络，需要正确配置NEO4J_URI
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  # 后端服务 - FastAPI应用
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: medical-backend:latest
    container_name: medical-backend
    ports:
      - "${BACKEND_PORT:-8012}:8012"
    environment:
      # Neo4j配置 - 连接到外部Neo4j
      - NEO4J_URI=${NEO4J_URI}
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      
      # Redis配置 - 连接到外部Redis
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_DB=${REDIS_DB:-0}
      
      # LLM配置
      - LLM_MODEL=${LLM_MODEL:-qwen2.5:14b}
      - LLM_BASE_URL=${LLM_BASE_URL:-https://zjlchat.vip.cpolar.cn/v1}
      - LLM_API_KEY=${LLM_API_KEY:-EMPTY}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE:-0.1}
      - LLM_TOP_P=${LLM_TOP_P:-0.8}
      
      # MCP配置
      - MCP_TRIAGE_URL=http://mcp:8000/sse
      
      # 文档处理配置
      - CHUNK_SIZE=${CHUNK_SIZE:-2000}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - REQUEST_INTERVAL=${REQUEST_INTERVAL:-1}
    volumes:
      # 持久化数据目录
      - ./patient_data:/app/patient_data
      - ./Knowledges:/app/Knowledges
      - ./temp_uploads:/app/temp_uploads
      - ./RAG/DB:/app/RAG/DB
      
      # 模型目录（与MCP共享）
      - ${HOST_MODEL_PATH:-./RAG/models}:/app/RAG/models
    depends_on:
      mcp:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8012\")' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - medical-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  # 前端服务 - Vue.js + Nginx
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: medical-frontend:latest
    container_name: medical-frontend
    ports:
      - "${FRONTEND_PORT:-80}:80"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - medical-network
    restart: unless-stopped

# ==========================================================================
# 网络定义
# ==========================================================================
networks:
  medical-network:
    driver: bridge
    name: medical-network

