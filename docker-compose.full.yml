# ============================================================================
# 医疗多智能体系统 - 完整部署配置
# 包含所有服务：Redis、Neo4j、MCP、Backend、Frontend
# 适用场景：第一次部署或完全从头开始
# 使用方式：docker-compose -f docker-compose.full.yml up -d
# ============================================================================

 

services:
  # ==========================================================================
  # 数据库服务
  # ==========================================================================
  
  # Redis服务 - 缓存和向量存储
  redis:
    image: redis:8.2-alpine
    container_name: medical-redis
    ports:
      - "${REDIS_EXTERNAL_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: >
      redis-server 
      --appendonly yes
      ${REDIS_PASSWORD:+--requirepass ${REDIS_PASSWORD}}
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - medical-network
    restart: unless-stopped

  # Neo4j服务 - 知识图谱数据库
  neo4j:
    image: neo4j:5.23
    container_name: medical-neo4j
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:7474"  # HTTP
      - "${NEO4J_BOLT_PORT:-7687}:7687"  # Bolt
    environment:
      - NEO4J_AUTH=${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-test1234}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_memory_pagecache_size=${NEO4J_MEMORY_PAGECACHE:-1G}
      - NEO4J_dbms_memory_heap_initial__size=${NEO4J_MEMORY_HEAP_INITIAL:-1G}
      - NEO4J_dbms_memory_heap_max__size=${NEO4J_MEMORY_HEAP_MAX:-2G}
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "${NEO4J_USER:-neo4j}", "-p", "${NEO4J_PASSWORD:-test1234}", "RETURN 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - medical-network
    restart: unless-stopped

  # ==========================================================================
  # 应用服务
  # ==========================================================================

  # MCP服务 - 模型上下文协议服务（症状搜索和诊断建议）
  mcp:
    build:
      context: .
      dockerfile: Dockerfile.mcp
    image: medical-mcp:latest
    container_name: medical-mcp
    ports:
      - "${MCP_PORT:-8000}:8000"
    environment:
      # Neo4j配置
      - NEO4J_URI=${NEO4J_URI:-bolt://neo4j:7687}
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-test1234}
    volumes:
      # 模型目录（如果宿主机已下载模型，可挂载以避免重复下载）
      - ${HOST_MODEL_PATH:-./RAG/models}:/app/RAG/models
    depends_on:
      neo4j:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8000/sse || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - medical-network
    restart: unless-stopped

  # 后端服务 - FastAPI应用
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: medical-backend:latest
    container_name: medical-backend
    ports:
      - "${BACKEND_PORT:-8012}:8012"
    environment:
      # Neo4j配置
      - NEO4J_URI=${NEO4J_URI:-bolt://neo4j:7687}
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-test1234}
      
      # Redis配置
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_DB=${REDIS_DB:-0}
      
      # LLM配置
      - LLM_MODEL=${LLM_MODEL:-qwen2.5:14b}
      - LLM_BASE_URL=${LLM_BASE_URL:-https://zjlchat.vip.cpolar.cn/v1}
      - LLM_API_KEY=${LLM_API_KEY:-EMPTY}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE:-0.1}
      - LLM_TOP_P=${LLM_TOP_P:-0.8}
      
      # MCP配置
      - MCP_TRIAGE_URL=${MCP_TRIAGE_URL:-http://mcp:8000/sse}
      
      # 文档处理配置
      - CHUNK_SIZE=${CHUNK_SIZE:-2000}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - REQUEST_INTERVAL=${REQUEST_INTERVAL:-1}
    volumes:
      # 持久化数据目录
      - ./patient_data:/app/patient_data
      - ./Knowledges:/app/Knowledges
      - ./temp_uploads:/app/temp_uploads
      - ./RAG/DB:/app/RAG/DB
      
      # 模型目录（与MCP共享）
      - ${HOST_MODEL_PATH:-./RAG/models}:/app/RAG/models
    depends_on:
      redis:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      mcp:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8012\")' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - medical-network
    restart: unless-stopped

  # 前端服务 - Vue.js + Nginx
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: medical-frontend:latest
    container_name: medical-frontend
    ports:
      - "${FRONTEND_PORT:-80}:80"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - medical-network
    restart: unless-stopped

# ==========================================================================
# 数据卷定义
# ==========================================================================
volumes:
  redis_data:
    driver: local
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_import:
    driver: local
  neo4j_plugins:
    driver: local

# ==========================================================================
# 网络定义
# ==========================================================================
networks:
  medical-network:
    driver: bridge
    name: medical-network

