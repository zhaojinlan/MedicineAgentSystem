# Recommend Node MCPé›†æˆå®æ–½è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å®ç°äº†`recommend_node`é€šè¿‡MCPæœåŠ¡è·å–é€šç”¨è¯Šæ–­æ£€æŸ¥æ–¹æ³•çš„åŠŸèƒ½ï¼Œç¡®ä¿å½“çŸ¥è¯†å›¾è°±ä¸­æ²¡æœ‰ç‰¹å®šç–¾ç—…çš„è¯Šæ–­æ–¹æ³•æ—¶ï¼Œç³»ç»Ÿä»èƒ½æä¾›æœ‰ä»·å€¼çš„é€šç”¨æ£€æŸ¥å»ºè®®ã€‚

---

## ğŸ¯ å®æ–½å†…å®¹

### 1. MCPæœåŠ¡æ–°å¢å·¥å…·

**æ–‡ä»¶**: `MCP/mcp_server.py`

æ–°å¢äº† `get_common_diagnostic_methods` å·¥å…·ï¼š

```python
@mcp.tool()
def get_common_diagnostic_methods(
    limit: int = 15,
    category_filter: Optional[str] = None
) -> Dict[str, Any]:
    """
    ä»çŸ¥è¯†å›¾è°±ä¸­è·å–é€šç”¨çš„è¯Šæ–­æ£€æŸ¥æ–¹æ³•ï¼ˆä¸é™å®šç‰¹å®šç–¾ç—…ï¼‰
    
    å‚æ•°:
      - limit: è¿”å›çš„æ£€æŸ¥æ–¹æ³•æ•°é‡ä¸Šé™ï¼ˆé»˜è®¤15ï¼‰
      - category_filter: å¯é€‰çš„ç±»åˆ«ç­›é€‰
      
    è¿”å›:
      åŒ…å«è¯Šæ–­æ–¹æ³•åˆ—è¡¨ã€ä½¿ç”¨é¢‘ç‡ã€ç›¸å…³ç–¾ç—…ç­‰ä¿¡æ¯
    """
```

**åŠŸèƒ½**ï¼š
- æŸ¥è¯¢Neo4jä¸­æ‰€æœ‰é€šè¿‡`DIAGNOSED_BY`å…³ç³»çš„è¯Šæ–­æ–¹æ³•èŠ‚ç‚¹
- æŒ‰ä½¿ç”¨é¢‘ç‡ï¼ˆè¢«å¤šå°‘ä¸ªç–¾ç—…ä½¿ç”¨ï¼‰é™åºæ’åº
- è¿”å›æ–¹æ³•åç§°ã€æè¿°ã€åˆ†ç±»ã€ä½¿ç”¨æ¬¡æ•°ã€ç›¸å…³ç–¾ç—…ç¤ºä¾‹

---

### 2. Recommend Node MCPé›†æˆ

**æ–‡ä»¶**: `Agent/recommend_node.py`

#### 2.1 å¯¼å…¥MCPç›¸å…³æ¨¡å—

```python
from langchain_mcp_adapters.client import MultiServerMCPClient
import asyncio
import concurrent.futures
```

#### 2.2 MCPå®¢æˆ·ç«¯åˆå§‹åŒ–

æ–°å¢äº† `initialize_mcp_client()` å¼‚æ­¥å‡½æ•°å’Œ `get_or_create_medical_analysis_node()` å‡½æ•°ï¼š

- **æ‡’åŠ è½½æœºåˆ¶**ï¼šé¦–æ¬¡è°ƒç”¨æ—¶æ‰åˆå§‹åŒ–MCPå®¢æˆ·ç«¯
- **äº‹ä»¶å¾ªç¯å¤„ç†**ï¼šæ™ºèƒ½å¤„ç†asyncioäº‹ä»¶å¾ªç¯å†²çª
- **é”™è¯¯å®¹é”™**ï¼šMCPåˆå§‹åŒ–å¤±è´¥æ—¶é™çº§ä¸ºåŸºç¡€å·¥å…·

#### 2.3 æ™ºèƒ½ä½“å·¥å…·é›†æˆ

`MedicalAnalysisNode`ç±»ç°åœ¨æ¥å—`mcp_tools`å‚æ•°ï¼š

```python
class MedicalAnalysisNode:
    def __init__(self, mcp_tools: Optional[List] = None):
        # åŸºç¡€å·¥å…·
        base_tools = [analyze_disease_probability, get_diagnostic_tests_for_disease]
        
        # æ·»åŠ MCPå·¥å…·ï¼ˆåŒ…å«get_common_diagnostic_methodsï¼‰
        all_tools = base_tools + (mcp_tools or [])
        
        self.agent = create_react_agent(
            model=model,
            tools=all_tools,
            prompt=MEDICAL_ANALYSIS_PROMPT
        )
```

#### 2.4 æç¤ºè¯æ›´æ–°

åœ¨`MEDICAL_ANALYSIS_PROMPT`ä¸­æ·»åŠ äº†fallbackç­–ç•¥è¯´æ˜ï¼š

```
ã€é‡è¦ã€‘å…³äºæ¨èæ£€æŸ¥çš„fallbackç­–ç•¥ï¼š
1. é¦–å…ˆè°ƒç”¨get_diagnostic_tests_for_diseaseå·¥å…·è·å–ç‰¹å®šç–¾ç—…çš„è¯Šæ–­æ–¹æ³•
2. å¦‚æœè¿”å›ç»“æœåŒ…å«"æš‚æ— è¯Šæ–­æ–¹æ³•"ã€"çŸ¥è¯†å›¾è°±ä¸­æœªæ‰¾åˆ°"ç­‰æç¤º
3. ç«‹å³è°ƒç”¨get_common_diagnostic_methodså·¥å…·ï¼ˆlimit=10æˆ–15ï¼‰
4. get_common_diagnostic_methodsä¼šä»çŸ¥è¯†å›¾è°±æŸ¥è¯¢é€šç”¨è¯Šæ–­æ–¹æ³•
5. åœ¨è¾“å‡ºä¸­æ˜ç¡®è¯´æ˜è¿™æ˜¯é€šç”¨æ£€æŸ¥å»ºè®®
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### æ­£å¸¸æµç¨‹ï¼ˆæœ‰ç‰¹å¼‚æ€§è¯Šæ–­æ–¹æ³•ï¼‰

```
ç”¨æˆ·è¾“å…¥ç—‡çŠ¶ 
  â†“
Triage Nodeåˆ†è¯Š 
  â†“
Experts Nodeæå–é£é™©å› å­
  â†“
Recommend Nodeåˆ†æ
  â†“
æ™ºèƒ½ä½“è°ƒç”¨get_diagnostic_tests_for_disease("ç–¾ç—…A")
  â†“
è¿”å›ï¼š[{"test_name": "ç‰¹å¼‚æ€§æ£€æŸ¥1", ...}, ...]
  â†“
è¾“å‡ºè¯Šæ–­å»ºè®®å’Œæ£€æŸ¥é¡¹ç›®
```

### Fallbackæµç¨‹ï¼ˆæ— ç‰¹å¼‚æ€§è¯Šæ–­æ–¹æ³•ï¼‰

```
ç”¨æˆ·è¾“å…¥ç—‡çŠ¶ 
  â†“
Triage Nodeåˆ†è¯Š 
  â†“
Experts Nodeæå–é£é™©å› å­
  â†“
Recommend Nodeåˆ†æ
  â†“
æ™ºèƒ½ä½“è°ƒç”¨get_diagnostic_tests_for_disease("ç½•è§ç–¾ç—…X")
  â†“
è¿”å›ï¼š[{"test_name": "æš‚æ— è¯Šæ–­æ–¹æ³•", "test_description": "çŸ¥è¯†å›¾è°±ä¸­æœªæ‰¾åˆ°..."}]
  â†“
æ™ºèƒ½ä½“è¯†åˆ«åˆ°fallbackæ ‡è¯†
  â†“
æ™ºèƒ½ä½“è°ƒç”¨get_common_diagnostic_methods(limit=10) ã€MCPå·¥å…·ã€‘
  â†“
MCPæœåŠ¡æŸ¥è¯¢Neo4jï¼š
  MATCH (m)<-[:DIAGNOSED_BY]-(d)
  WITH m, collect(DISTINCT d.name) AS diseases
  RETURN m.name, m.description, size(diseases) AS usage_count
  ORDER BY usage_count DESC
  â†“
è¿”å›ï¼š10ä¸ªé€šç”¨æ£€æŸ¥æ–¹æ³•ï¼ˆæŒ‰ä½¿ç”¨é¢‘ç‡æ’åºï¼‰
  â†“
è¾“å‡ºè¯Šæ–­å»ºè®®å’Œé€šç”¨æ£€æŸ¥é¡¹ç›®
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ¡ˆ

### æµ‹è¯•å‰å‡†å¤‡

1. **å¯åŠ¨MCPæœåŠ¡**

```bash
cd MCP
python mcp_server.py
```

ç¡®ä¿æœåŠ¡è¿è¡Œåœ¨ `http://localhost:8000/sse`

2. **æ£€æŸ¥Neo4jè¿æ¥**

ç¡®ä¿Neo4jè¿è¡Œæ­£å¸¸ï¼ŒåŒ…å«è¯Šæ–­æ–¹æ³•èŠ‚ç‚¹ï¼š

```cypher
// æŸ¥è¯¢ç°æœ‰è¯Šæ–­æ–¹æ³•æ•°é‡
MATCH (m)<-[:DIAGNOSED_BY]-(d)
RETURN count(DISTINCT m) as method_count, 
       count(DISTINCT d) as disease_count
```

3. **æ£€æŸ¥é…ç½®**

ç¡®ä¿`config.py`ä¸­MCPé…ç½®æ­£ç¡®ï¼š

```python
MCP_CONFIG = {
    "servers": {
        "triage": {
            "url": "http://localhost:8000/sse",
            "headers": {},
            "transport": "sse"
        }
    }
}
```

### æµ‹è¯•ç”¨ä¾‹

#### æµ‹è¯•1ï¼šæœ‰ç‰¹å¼‚æ€§è¯Šæ–­æ–¹æ³•çš„ç–¾ç—…

**è¾“å…¥**ï¼š
```
æ‚£è€…ç—‡çŠ¶ï¼šçš®è‚¤çº¢è‚¿ã€ç–¼ç—›ã€å‘çƒ­
é£é™©å› ç´ ï¼šç³–å°¿ç—…ã€é«˜é¾„
å¯èƒ½ç–¾ç—…ï¼šåæ­»æ€§è½¯ç»„ç»‡æ„ŸæŸ“ï¼ˆå‡è®¾çŸ¥è¯†å›¾è°±ä¸­æœ‰è¯¥ç–¾ç—…çš„è¯Šæ–­æ–¹æ³•ï¼‰
```

**é¢„æœŸè¡Œä¸º**ï¼š
1. æ™ºèƒ½ä½“è°ƒç”¨`get_diagnostic_tests_for_disease("åæ­»æ€§è½¯ç»„ç»‡æ„ŸæŸ“")`
2. è¿”å›ç‰¹å¼‚æ€§æ£€æŸ¥æ–¹æ³•ï¼ˆå¦‚"å±€éƒ¨ç»„ç»‡æ´»æ£€"ã€"è¡€åŸ¹å…»"ç­‰ï¼‰
3. **ä¸è°ƒç”¨**`get_common_diagnostic_methods`
4. è¾“å‡ºåŒ…å«ç‰¹å¼‚æ€§æ£€æŸ¥å»ºè®®

#### æµ‹è¯•2ï¼šæ— ç‰¹å¼‚æ€§è¯Šæ–­æ–¹æ³•çš„ç–¾ç—…

**è¾“å…¥**ï¼š
```
æ‚£è€…ç—‡çŠ¶ï¼šç½•è§ç—‡çŠ¶ç»„åˆ
å¯èƒ½ç–¾ç—…ï¼šçŸ¥è¯†å›¾è°±ä¸­æœªå½•å…¥çš„ç½•è§ç–¾ç—…
```

**é¢„æœŸè¡Œä¸º**ï¼š
1. æ™ºèƒ½ä½“è°ƒç”¨`get_diagnostic_tests_for_disease("ç½•è§ç–¾ç—…X")`
2. è¿”å›ç©ºæˆ–"æš‚æ— è¯Šæ–­æ–¹æ³•"
3. æ™ºèƒ½ä½“è¯†åˆ«åˆ°fallbackåœºæ™¯
4. **è°ƒç”¨**`get_common_diagnostic_methods(limit=10)`
5. MCPæœåŠ¡æŸ¥è¯¢Neo4jè¿”å›10ä¸ªé€šç”¨æ£€æŸ¥æ–¹æ³•
6. è¾“å‡ºåŒ…å«é€šç”¨æ£€æŸ¥å»ºè®®ï¼Œå¹¶è¯´æ˜"ç”±äºçŸ¥è¯†å›¾è°±ä¸­æš‚æ— è¯¥ç–¾ç—…çš„ç‰¹å¼‚æ€§è¯Šæ–­æ–¹æ³•"

#### æµ‹è¯•3ï¼šMCPæœåŠ¡ä¸å¯ç”¨

**æ¨¡æ‹Ÿåœºæ™¯**ï¼šåœæ­¢MCPæœåŠ¡

**é¢„æœŸè¡Œä¸º**ï¼š
1. MCPå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥
2. `get_or_create_medical_analysis_node()`æ•è·å¼‚å¸¸
3. è®¾ç½®`_mcp_tools = []`
4. `MedicalAnalysisNode`ä»…ä½¿ç”¨åŸºç¡€å·¥å…·
5. ç³»ç»Ÿé™çº§ä½†ä»èƒ½æ­£å¸¸è¿è¡Œï¼ˆåªæ˜¯æ²¡æœ‰fallbackåŠŸèƒ½ï¼‰
6. æ—¥å¿—è¾“å‡ºï¼š`è­¦å‘Š: MCPå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥`

### æµ‹è¯•å‘½ä»¤

#### å•å…ƒæµ‹è¯•recommend_node

```bash
cd Agent
python recommend_node.py
```

#### é›†æˆæµ‹è¯•ï¼ˆé€šè¿‡backend_apiï¼‰

```bash
# å¯åŠ¨åç«¯
python backend_api.py

# é€šè¿‡APIæµ‹è¯•
curl -X POST http://localhost:5000/api/agent/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "patient_id": "test_001",
    "symptoms": "çš®è‚¤çº¢è‚¿ã€ç–¼ç—›ã€å‘çƒ­",
    "disease": "æœªçŸ¥ç½•è§ç–¾ç—…"
  }'
```

---

## ğŸ“Š éªŒè¯MCPå·¥å…·æ˜¯å¦è¢«æ­£ç¡®åŠ è½½

### æ–¹æ³•1ï¼šæŸ¥çœ‹æ—¥å¿—

å¯åŠ¨recommend_nodeæ—¶ï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼š

```
>>> MCPå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸï¼Œè·å¾— 2 ä¸ªå·¥å…·
>>> Medical Analysis Node åˆå§‹åŒ–å®Œæˆï¼Œå·¥å…·æ•°: 4
```

å…¶ä¸­ï¼š
- 2ä¸ªMCPå·¥å…·ï¼š`symptom_search_analyze`, `get_common_diagnostic_methods`
- 2ä¸ªåŸºç¡€å·¥å…·ï¼š`analyze_disease_probability`, `get_diagnostic_tests_for_disease`
- æ€»è®¡ï¼š4ä¸ªå·¥å…·

### æ–¹æ³•2ï¼šç›´æ¥æµ‹è¯•MCPå·¥å…·

```python
import asyncio
from langchain_mcp_adapters.client import MultiServerMCPClient

async def test_mcp_tool():
    client = MultiServerMCPClient({
        "triage": {
            "url": "http://localhost:8000/sse",
            "headers": {},
            "transport": "sse"
        }
    })
    
    tools = await client.get_tools()
    print(f"å¯ç”¨å·¥å…·: {[tool.name for tool in tools]}")
    
    # æµ‹è¯•get_common_diagnostic_methods
    result = await client.call_tool(
        "triage",
        "get_common_diagnostic_methods",
        {"limit": 5}
    )
    print(f"ç»“æœ: {result}")

asyncio.run(test_mcp_tool())
```

---

## ğŸ” æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šMCPå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
>>> è­¦å‘Š: MCPå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: [Errno 111] Connection refused
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥MCPæœåŠ¡æ˜¯å¦è¿è¡Œï¼š`python MCP/mcp_server.py`
2. æ£€æŸ¥ç«¯å£æ˜¯å¦æ­£ç¡®ï¼šé»˜è®¤8000
3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### é—®é¢˜2ï¼šæ™ºèƒ½ä½“æœªè°ƒç”¨get_common_diagnostic_methods

**ç—‡çŠ¶**ï¼šå³ä½¿æ²¡æœ‰ç‰¹å¼‚æ€§è¯Šæ–­æ–¹æ³•ï¼Œæ™ºèƒ½ä½“ä¹Ÿä¸è°ƒç”¨fallbackå·¥å…·

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æç¤ºè¯æ˜¯å¦æ­£ç¡®æ›´æ–°
2. ç¡®è®¤MCPå·¥å…·å·²æ­£ç¡®åŠ è½½ï¼ˆæŸ¥çœ‹æ—¥å¿—ï¼‰
3. å¢å¼ºæç¤ºè¯ä¸­çš„æŒ‡ä»¤å¼ºåº¦
4. æ£€æŸ¥`get_diagnostic_tests_for_disease`çš„è¿”å›æ ¼å¼

### é—®é¢˜3ï¼šNeo4jæŸ¥è¯¢æ— ç»“æœ

**ç—‡çŠ¶**ï¼š
```json
{"methods_count": 0, "methods": []}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥Neo4jä¸­æ˜¯å¦æœ‰`DIAGNOSED_BY`å…³ç³»ï¼š
```cypher
MATCH ()-[r:DIAGNOSED_BY]->()
RETURN count(r)
```
2. æ£€æŸ¥è¯Šæ–­æ–¹æ³•èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼š
```cypher
MATCH (m)<-[:DIAGNOSED_BY]-()
RETURN m LIMIT 10
```
3. å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œéœ€è¦å…ˆæ„å»ºçŸ¥è¯†å›¾è°±

---

## ğŸ“ˆ æ€§èƒ½è€ƒè™‘

- **MCPå®¢æˆ·ç«¯åˆå§‹åŒ–**ï¼šé¦–æ¬¡è°ƒç”¨çº¦éœ€1-3ç§’ï¼ˆå¼‚æ­¥ï¼‰
- **Neo4jæŸ¥è¯¢**ï¼š`get_common_diagnostic_methods`æŸ¥è¯¢çº¦éœ€50-200ms
- **æ™ºèƒ½ä½“æ¨ç†**ï¼šå¢åŠ MCPå·¥å…·åï¼Œæ¨ç†æ—¶é—´å¢åŠ çº¦10-20%ï¼ˆå› ä¸ºå·¥å…·æ•°é‡å¢åŠ ï¼‰

---

## ğŸ”„ æœªæ¥ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜æœºåˆ¶**ï¼šç¼“å­˜`get_common_diagnostic_methods`çš„ç»“æœï¼ˆ1å°æ—¶æœ‰æ•ˆæœŸï¼‰
2. **æ™ºèƒ½ç­›é€‰**ï¼šåŸºäºæ‚£è€…ç—‡çŠ¶å…³é”®è¯æ™ºèƒ½ç­›é€‰é€šç”¨æ£€æŸ¥ï¼ˆä½¿ç”¨`category_filter`å‚æ•°ï¼‰
3. **æ£€æŸ¥ä¼˜å…ˆçº§**ï¼šä¸ºé€šç”¨æ£€æŸ¥æ·»åŠ ä¼˜å…ˆçº§å­—æ®µï¼Œä¼˜å…ˆæ¨èé«˜ä¼˜å…ˆçº§æ£€æŸ¥
4. **å¤šè¯­è¨€æ”¯æŒ**ï¼šæ”¯æŒè¿”å›ä¸åŒè¯­è¨€çš„æ£€æŸ¥åç§°å’Œæè¿°
5. **æ£€æŸ¥æˆæœ¬**ï¼šæ·»åŠ æ£€æŸ¥è´¹ç”¨å­—æ®µï¼Œå¸®åŠ©åŒ»ç”Ÿè¿›è¡Œæˆæœ¬æ•ˆç›Šåˆ†æ

---

## âœ… éªŒæ”¶æ ‡å‡†

- [x] MCPæœåŠ¡æˆåŠŸæ·»åŠ `get_common_diagnostic_methods`å·¥å…·
- [x] Recommend NodeæˆåŠŸé›†æˆMCPå®¢æˆ·ç«¯
- [x] æ™ºèƒ½ä½“åœ¨æ²¡æœ‰ç‰¹å¼‚æ€§è¯Šæ–­æ–¹æ³•æ—¶è‡ªåŠ¨è°ƒç”¨fallbackå·¥å…·
- [x] ç³»ç»Ÿåœ¨MCPæœåŠ¡ä¸å¯ç”¨æ—¶èƒ½æ­£å¸¸é™çº§
- [x] æ— linteré”™è¯¯
- [x] æç¤ºè¯æ¸…æ™°å¼•å¯¼æ™ºèƒ½ä½“ä½¿ç”¨fallbackç­–ç•¥

---

## ğŸ“ æ€»ç»“

æœ¬æ¬¡å®æ–½å®Œæˆäº†ä»¥ä¸‹ç›®æ ‡ï¼š

1. âœ… **æ¶æ„ä¸€è‡´æ€§**ï¼šæ‰€æœ‰çŸ¥è¯†å›¾è°±è®¿é—®é€šè¿‡MCPæœåŠ¡ç»Ÿä¸€ç®¡ç†
2. âœ… **åŠŸèƒ½å®Œæ•´æ€§**ï¼šå³ä½¿çŸ¥è¯†å›¾è°±ä¸å®Œæ•´ï¼Œç³»ç»Ÿä»èƒ½æä¾›æœ‰ä»·å€¼çš„å»ºè®®
3. âœ… **å®¹é”™æ€§**ï¼šMCPæœåŠ¡ä¸å¯ç”¨æ—¶ç³»ç»Ÿèƒ½é™çº§è¿è¡Œ
4. âœ… **å¯æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ æ–°çš„MCPå·¥å…·å’Œæ£€æŸ¥ç±»å‹
5. âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šæ‚£è€…æ€»èƒ½è·å¾—æ£€æŸ¥å»ºè®®ï¼Œä¸ä¼šå› ä¸ºæ•°æ®ç¼ºå¤±è€Œå¾—åˆ°ç©ºç»“æœ

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- ä»£ç æ³¨é‡Šï¼šè¯¦ç»†çš„å®ç°è¯´æ˜
- æ—¥å¿—è¾“å‡ºï¼šè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
- æœ¬æ–‡æ¡£ï¼šå®Œæ•´çš„ä½¿ç”¨æŒ‡å—

